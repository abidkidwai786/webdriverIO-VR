"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
require("source-map-support/register");
var _nodeRestClient = _interopRequireDefault(require("@lambdatest/node-rest-client"));
var _logger = _interopRequireDefault(require("@wdio/logger"));
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }
const log = (0, _logger.default)('@wdio/lambdatest-service');
class LambdaRestService {
  constructor() {
    this.testCnt = 0;
    this.failures = 0;
  }
  beforeSession(config, capabilities) {
    this.config = config;
    this.capabilities = capabilities;
    const lambdaCredentials = {
      username: this.config.user,
      accessKey: this.config.key,
      isApp: false
    };
    if (this.config.product === 'appAutomation') lambdaCredentials.isApp = true;
    if (this.config.logFile) {
      lambdaCredentials.logFile = this.config.logFile;
    }
    this.isServiceEnabled = lambdaCredentials.username && lambdaCredentials.accessKey;
    try {
      this.api = _nodeRestClient.default.AutomationClient(lambdaCredentials);
    } catch (_) {
      this.isServiceEnabled = false;
    }
  }
  beforeScenario(world, context) {
    if (!this.suiteTitle) {
      var _world$gherkinDocumen, _world$gherkinDocumen2, _context$document, _context$document$fea, _world$pickle;
      this.suiteTitle = (world === null || world === void 0 ? void 0 : (_world$gherkinDocumen = world.gherkinDocument) === null || _world$gherkinDocumen === void 0 ? void 0 : (_world$gherkinDocumen2 = _world$gherkinDocumen.feature) === null || _world$gherkinDocumen2 === void 0 ? void 0 : _world$gherkinDocumen2.name) || (context === null || context === void 0 ? void 0 : (_context$document = context.document) === null || _context$document === void 0 ? void 0 : (_context$document$fea = _context$document.feature) === null || _context$document$fea === void 0 ? void 0 : _context$document$fea.name) || (world === null || world === void 0 ? void 0 : (_world$pickle = world.pickle) === null || _world$pickle === void 0 ? void 0 : _world$pickle.name) || 'unknown scenario';
    }
  }
  beforeSuite(suite) {
    this.suiteTitle = suite.title;
  }
  beforeTest(test) {
    if (!this.isServiceEnabled) {
      return;
    }
    if (test.title && !this.testTitle) {
      this.testTitle = test.title;
    }
    if (this.suiteTitle === 'Jasmine__TopLevel__Suite') {
      const testSuiteName = test.fullName.slice(0, test.fullName.indexOf(test.description || '') - 1);
      this.suiteTitle = testSuiteName;
      global.browser.execute("lambda-name=" + this.suiteTitle);
    }
  }
  beforeStep(step) {
    if (!this.suiteTitle || this.suiteTitle == 'unknown scenario') {
      var _step$document, _step$document$featur, _step$step, _step$step$scenario;
      this.suiteTitle = (step === null || step === void 0 ? void 0 : (_step$document = step.document) === null || _step$document === void 0 ? void 0 : (_step$document$featur = _step$document.feature) === null || _step$document$featur === void 0 ? void 0 : _step$document$featur.name) || (step === null || step === void 0 ? void 0 : (_step$step = step.step) === null || _step$step === void 0 ? void 0 : (_step$step$scenario = _step$step.scenario) === null || _step$step$scenario === void 0 ? void 0 : _step$step$scenario.name) || 'unknown scenario';
    }
  }
  afterSuite(suite) {
    if (Object.prototype.hasOwnProperty.call(suite, 'error')) {
      ++this.failures;
    }
  }
  afterTest(test, context, {
    error,
    result,
    duration,
    passed,
    retries
  }) {
    console.log(error, result, duration, retries);
    if (!passed) {
      ++this.failures;
    }
  }
  afterScenario(world, {
    passed,
    error,
    duration
  }) {
    console.log(error, duration);
    if (!passed) {
      ++this.failures;
    }
  }
  after(result) {
    if (!this.isServiceEnabled) {
      return;
    }
    let failures = this.failures;
    if (global.browser.options.mochaOpts && global.browser.options.mochaOpts.bail && Boolean(result)) {
      failures = 1;
    }
    if (result === 0) {
      failures = 0;
    }
    const status = 'status: ' + (failures > 0 ? 'failed' : 'passed');
    if (!global.browser.isMultiremote) {
      log.info(`Update job with sessionId ${global.browser.sessionId}, ${status}`);
      return this._update(global.browser.sessionId, failures);
    }
    return Promise.all(Object.keys(this.capabilities).map(browserName => {
      log.info(`Update multiremote job for browser '${browserName}' and sessionId ${global.browser[browserName].sessionId}, ${status}`);
      return this._update(global.browser[browserName].sessionId, failures, false, browserName);
    }));
  }
  onReload(oldSessionId, newSessionId) {
    if (!this.isServiceEnabled) {
      return;
    }
    const status = 'status: ' + (this.failures > 0 ? 'failed' : 'passed');
    if (!global.browser.isMultiremote) {
      log.info(`Update (reloaded) job with sessionId ${oldSessionId}, ${status}`);
      return this._update(oldSessionId, this.failures, true);
    }
    const browserName = global.browser.instances.filter(browserName => global.browser[browserName].sessionId === newSessionId)[0];
    log.info(`Update (reloaded) multiremote job for browser '${browserName}' and sessionId ${oldSessionId}, ${status}`);
    return this._update(oldSessionId, this.failures, true, browserName);
  }
  async _update(sessionId, failures, calledOnReload = false, browserName) {
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    await sleep(5000);
    return await this.updateJob(sessionId, failures, calledOnReload, browserName);
  }
  async updateJob(sessionId, failures, calledOnReload = false, browserName) {
    const body = this.getBody(failures, calledOnReload, browserName);
    try {
      await new Promise((resolve, reject) => {
        this.api.updateSessionById(sessionId, body, (err, result) => {
          if (err) {
            return reject(err);
          }
          return resolve(result);
        });
      });
    } catch (ex) {
      console.log(ex);
    }
    this.failures = 0;
  }
  getBody(failures, calledOnReload = false, browserName) {
    let body = {};
    if (!(!global.browser.isMultiremote && this.capabilities.name || global.browser.isMultiremote && this.capabilities[browserName].capabilities.name)) {
      let testName = this.suiteTitle;
      body.name = testName;
      if (this.capabilities['LT:Options'] && this.capabilities['LT:Options'].name) {
        body.name = this.capabilities['LT:Options'].name;
      }
      if (browserName) {
        body.name = `${browserName}: ${body.name}`;
      }
      if (calledOnReload || this.testCnt) {
        let testCnt = ++this.testCnt;
        if (global.browser.isMultiremote) {
          testCnt = Math.ceil(testCnt / global.browser.instances.length);
        }
        body.name += ` (${testCnt})`;
      }
    }
    body.status_ind = failures > 0 ? 'failed' : 'passed';
    return body;
  }
}
exports.default = LambdaRestService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJsb2ciLCJsb2dnZXIiLCJMYW1iZGFSZXN0U2VydmljZSIsImNvbnN0cnVjdG9yIiwidGVzdENudCIsImZhaWx1cmVzIiwiYmVmb3JlU2Vzc2lvbiIsImNvbmZpZyIsImNhcGFiaWxpdGllcyIsImxhbWJkYUNyZWRlbnRpYWxzIiwidXNlcm5hbWUiLCJ1c2VyIiwiYWNjZXNzS2V5Iiwia2V5IiwiaXNBcHAiLCJwcm9kdWN0IiwibG9nRmlsZSIsImlzU2VydmljZUVuYWJsZWQiLCJhcGkiLCJMYW1iZGFSZXN0Q2xpZW50IiwiQXV0b21hdGlvbkNsaWVudCIsIl8iLCJiZWZvcmVTY2VuYXJpbyIsIndvcmxkIiwiY29udGV4dCIsInN1aXRlVGl0bGUiLCJnaGVya2luRG9jdW1lbnQiLCJmZWF0dXJlIiwibmFtZSIsImRvY3VtZW50IiwicGlja2xlIiwiYmVmb3JlU3VpdGUiLCJzdWl0ZSIsInRpdGxlIiwiYmVmb3JlVGVzdCIsInRlc3QiLCJ0ZXN0VGl0bGUiLCJ0ZXN0U3VpdGVOYW1lIiwiZnVsbE5hbWUiLCJzbGljZSIsImluZGV4T2YiLCJkZXNjcmlwdGlvbiIsImdsb2JhbCIsImJyb3dzZXIiLCJleGVjdXRlIiwiYmVmb3JlU3RlcCIsInN0ZXAiLCJzY2VuYXJpbyIsImFmdGVyU3VpdGUiLCJPYmplY3QiLCJwcm90b3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJhZnRlclRlc3QiLCJlcnJvciIsInJlc3VsdCIsImR1cmF0aW9uIiwicGFzc2VkIiwicmV0cmllcyIsImNvbnNvbGUiLCJhZnRlclNjZW5hcmlvIiwiYWZ0ZXIiLCJvcHRpb25zIiwibW9jaGFPcHRzIiwiYmFpbCIsIkJvb2xlYW4iLCJzdGF0dXMiLCJpc011bHRpcmVtb3RlIiwiaW5mbyIsInNlc3Npb25JZCIsIl91cGRhdGUiLCJQcm9taXNlIiwiYWxsIiwia2V5cyIsIm1hcCIsImJyb3dzZXJOYW1lIiwib25SZWxvYWQiLCJvbGRTZXNzaW9uSWQiLCJuZXdTZXNzaW9uSWQiLCJpbnN0YW5jZXMiLCJmaWx0ZXIiLCJjYWxsZWRPblJlbG9hZCIsInNsZWVwIiwibXMiLCJyIiwic2V0VGltZW91dCIsInVwZGF0ZUpvYiIsImJvZHkiLCJnZXRCb2R5IiwicmVzb2x2ZSIsInJlamVjdCIsInVwZGF0ZVNlc3Npb25CeUlkIiwiZXJyIiwiZXgiLCJ0ZXN0TmFtZSIsIk1hdGgiLCJjZWlsIiwibGVuZ3RoIiwic3RhdHVzX2luZCJdLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2aWNlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBMYW1iZGFSZXN0Q2xpZW50IGZyb20gJ0BsYW1iZGF0ZXN0L25vZGUtcmVzdC1jbGllbnQnXG5pbXBvcnQgbG9nZ2VyIGZyb20gJ0B3ZGlvL2xvZ2dlcidcblxuY29uc3QgbG9nID0gbG9nZ2VyKCdAd2Rpby9sYW1iZGF0ZXN0LXNlcnZpY2UnKVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBMYW1iZGFSZXN0U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMudGVzdENudCA9IDA7XG4gICAgdGhpcy5mYWlsdXJlcyA9IDA7XG4gIH1cblxuICBiZWZvcmVTZXNzaW9uKGNvbmZpZywgY2FwYWJpbGl0aWVzKSB7XG4gICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgdGhpcy5jYXBhYmlsaXRpZXMgPSBjYXBhYmlsaXRpZXM7XG4gICAgY29uc3QgbGFtYmRhQ3JlZGVudGlhbHMgPSB7XG4gICAgICB1c2VybmFtZTogdGhpcy5jb25maWcudXNlcixcbiAgICAgIGFjY2Vzc0tleTogdGhpcy5jb25maWcua2V5LFxuICAgICAgaXNBcHAgOiBmYWxzZVxuICAgIH07XG5cbiAgICBpZiAodGhpcy5jb25maWcucHJvZHVjdCA9PT0gJ2FwcEF1dG9tYXRpb24nKSBsYW1iZGFDcmVkZW50aWFscy5pc0FwcCA9dHJ1ZVxuXG4gICAgaWYgKHRoaXMuY29uZmlnLmxvZ0ZpbGUpIHtcbiAgICAgIGxhbWJkYUNyZWRlbnRpYWxzLmxvZ0ZpbGUgPSB0aGlzLmNvbmZpZy5sb2dGaWxlO1xuICAgIH1cblxuICAgIHRoaXMuaXNTZXJ2aWNlRW5hYmxlZCA9IGxhbWJkYUNyZWRlbnRpYWxzLnVzZXJuYW1lICYmIGxhbWJkYUNyZWRlbnRpYWxzLmFjY2Vzc0tleTtcblxuICAgIHRyeSB7XG4gICAgICB0aGlzLmFwaSA9IExhbWJkYVJlc3RDbGllbnQuQXV0b21hdGlvbkNsaWVudChsYW1iZGFDcmVkZW50aWFscyk7XG4gICAgfSBjYXRjaCAoXykge1xuICAgICAgdGhpcy5pc1NlcnZpY2VFbmFibGVkID0gZmFsc2U7XG4gICAgfVxuICB9XG4gIGJlZm9yZVNjZW5hcmlvKHdvcmxkLCBjb250ZXh0KSB7XG4gICAgaWYgKCF0aGlzLnN1aXRlVGl0bGUpe1xuICAgICAgdGhpcy5zdWl0ZVRpdGxlID0gd29ybGQ/LmdoZXJraW5Eb2N1bWVudD8uZmVhdHVyZT8ubmFtZXx8IGNvbnRleHQ/LmRvY3VtZW50Py5mZWF0dXJlPy5uYW1lIHx8IHdvcmxkPy5waWNrbGU/Lm5hbWUgfHwgJ3Vua25vd24gc2NlbmFyaW8nO1xuICAgIH1cbiAgfVxuXG4gIGJlZm9yZVN1aXRlKHN1aXRlKSB7XG4gICAgdGhpcy5zdWl0ZVRpdGxlID0gc3VpdGUudGl0bGU7XG4gIH1cblxuICBiZWZvcmVUZXN0KHRlc3QpIHtcbiAgICBpZiAoIXRoaXMuaXNTZXJ2aWNlRW5hYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGVzdC50aXRsZSAmJiAhdGhpcy50ZXN0VGl0bGUpe1xuICAgICAgdGhpcy50ZXN0VGl0bGUgPSB0ZXN0LnRpdGxlXG4gICAgfVxuICAgIFxuICAgIGlmICh0aGlzLnN1aXRlVGl0bGUgPT09ICdKYXNtaW5lX19Ub3BMZXZlbF9fU3VpdGUnKSB7XG4gICAgICBjb25zdCB0ZXN0U3VpdGVOYW1lID0gdGVzdC5mdWxsTmFtZS5zbGljZSgwLCB0ZXN0LmZ1bGxOYW1lLmluZGV4T2YodGVzdC5kZXNjcmlwdGlvbiB8fCAnJykgLSAxKVxuICAgICAgdGhpcy5zdWl0ZVRpdGxlID0gdGVzdFN1aXRlTmFtZTtcbiAgICAgIGdsb2JhbC5icm93c2VyLmV4ZWN1dGUoXCJsYW1iZGEtbmFtZT1cIit0aGlzLnN1aXRlVGl0bGUpXG4gICAgfVxuICB9XG5cbiAgYmVmb3JlU3RlcChzdGVwKSB7XG4gICAgaWYgKCF0aGlzLnN1aXRlVGl0bGUgfHwgdGhpcy5zdWl0ZVRpdGxlID09ICd1bmtub3duIHNjZW5hcmlvJykge1xuICAgICAgdGhpcy5zdWl0ZVRpdGxlID0gc3RlcD8uZG9jdW1lbnQ/LmZlYXR1cmU/Lm5hbWUgfHwgc3RlcD8uc3RlcD8uc2NlbmFyaW8/Lm5hbWUgfHwgJ3Vua25vd24gc2NlbmFyaW8nO1xuICAgIH1cbiAgfVxuXG4gIGFmdGVyU3VpdGUoc3VpdGUpIHtcbiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHN1aXRlLCAnZXJyb3InKSkge1xuICAgICAgKyt0aGlzLmZhaWx1cmVzO1xuICAgIH1cbiAgfVxuXG4gIGFmdGVyVGVzdCh0ZXN0LCBjb250ZXh0LCB7XG4gICAgZXJyb3IsXG4gICAgcmVzdWx0LFxuICAgIGR1cmF0aW9uLFxuICAgIHBhc3NlZCxcbiAgICByZXRyaWVzXG4gIH0pIHtcbiAgICBjb25zb2xlLmxvZyhlcnJvciwgcmVzdWx0LCBkdXJhdGlvbiwgcmV0cmllcylcbiAgICBpZiAoIXBhc3NlZCkge1xuICAgICAgKyt0aGlzLmZhaWx1cmVzO1xuICAgIH1cbiAgfVxuXG4gIGFmdGVyU2NlbmFyaW8od29ybGQsIHsgcGFzc2VkLCBlcnJvciwgZHVyYXRpb24gfSkge1xuICAgIGNvbnNvbGUubG9nKGVycm9yLCBkdXJhdGlvbilcbiAgICBpZiAoIXBhc3NlZCkge1xuICAgICAgKyt0aGlzLmZhaWx1cmVzO1xuICAgIH1cbiAgfVxuXG4gIGFmdGVyKHJlc3VsdCkge1xuICAgIGlmICghdGhpcy5pc1NlcnZpY2VFbmFibGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbGV0IGZhaWx1cmVzID0gdGhpcy5mYWlsdXJlcztcblxuICAgIGlmIChnbG9iYWwuYnJvd3Nlci5vcHRpb25zLm1vY2hhT3B0cyAmJiBnbG9iYWwuYnJvd3Nlci5vcHRpb25zLm1vY2hhT3B0cy5iYWlsICYmIEJvb2xlYW4ocmVzdWx0KSkge1xuICAgICAgZmFpbHVyZXMgPSAxO1xuICAgIH1cbiAgICBcbiAgICBpZiAocmVzdWx0ID09PSAwKSB7XG4gICAgICBmYWlsdXJlcyA9IDA7XG4gICAgfVxuICAgIGNvbnN0IHN0YXR1cyA9ICdzdGF0dXM6ICcgKyAoZmFpbHVyZXMgPiAwID8gJ2ZhaWxlZCcgOiAncGFzc2VkJyk7XG5cbiAgICBpZiAoIWdsb2JhbC5icm93c2VyLmlzTXVsdGlyZW1vdGUpIHtcbiAgICAgIGxvZy5pbmZvKGBVcGRhdGUgam9iIHdpdGggc2Vzc2lvbklkICR7Z2xvYmFsLmJyb3dzZXIuc2Vzc2lvbklkfSwgJHtzdGF0dXN9YCk7XG4gICAgICByZXR1cm4gdGhpcy5fdXBkYXRlKGdsb2JhbC5icm93c2VyLnNlc3Npb25JZCwgZmFpbHVyZXMpO1xuICAgIH1cblxuICAgIHJldHVybiBQcm9taXNlLmFsbChPYmplY3Qua2V5cyh0aGlzLmNhcGFiaWxpdGllcykubWFwKGJyb3dzZXJOYW1lID0+IHtcbiAgICAgIGxvZy5pbmZvKGBVcGRhdGUgbXVsdGlyZW1vdGUgam9iIGZvciBicm93c2VyICcke2Jyb3dzZXJOYW1lfScgYW5kIHNlc3Npb25JZCAke2dsb2JhbC5icm93c2VyW2Jyb3dzZXJOYW1lXS5zZXNzaW9uSWR9LCAke3N0YXR1c31gKTtcbiAgICAgIHJldHVybiB0aGlzLl91cGRhdGUoZ2xvYmFsLmJyb3dzZXJbYnJvd3Nlck5hbWVdLnNlc3Npb25JZCwgZmFpbHVyZXMsIGZhbHNlLCBicm93c2VyTmFtZSk7XG4gICAgfSkpO1xuICB9XG5cbiAgb25SZWxvYWQob2xkU2Vzc2lvbklkLCBuZXdTZXNzaW9uSWQpIHtcbiAgICBpZiAoIXRoaXMuaXNTZXJ2aWNlRW5hYmxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHN0YXR1cyA9ICdzdGF0dXM6ICcgKyAodGhpcy5mYWlsdXJlcyA+IDAgPyAnZmFpbGVkJyA6ICdwYXNzZWQnKTtcblxuICAgIGlmICghZ2xvYmFsLmJyb3dzZXIuaXNNdWx0aXJlbW90ZSkge1xuICAgICAgbG9nLmluZm8oYFVwZGF0ZSAocmVsb2FkZWQpIGpvYiB3aXRoIHNlc3Npb25JZCAke29sZFNlc3Npb25JZH0sICR7c3RhdHVzfWApO1xuICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZShvbGRTZXNzaW9uSWQsIHRoaXMuZmFpbHVyZXMsIHRydWUpO1xuICAgIH1cblxuICAgIGNvbnN0IGJyb3dzZXJOYW1lID0gZ2xvYmFsLmJyb3dzZXIuaW5zdGFuY2VzLmZpbHRlcihicm93c2VyTmFtZSA9PiBnbG9iYWwuYnJvd3Nlclticm93c2VyTmFtZV0uc2Vzc2lvbklkID09PSBuZXdTZXNzaW9uSWQpWzBdO1xuICAgIGxvZy5pbmZvKGBVcGRhdGUgKHJlbG9hZGVkKSBtdWx0aXJlbW90ZSBqb2IgZm9yIGJyb3dzZXIgJyR7YnJvd3Nlck5hbWV9JyBhbmQgc2Vzc2lvbklkICR7b2xkU2Vzc2lvbklkfSwgJHtzdGF0dXN9YCk7XG4gICAgcmV0dXJuIHRoaXMuX3VwZGF0ZShvbGRTZXNzaW9uSWQsIHRoaXMuZmFpbHVyZXMsIHRydWUsIGJyb3dzZXJOYW1lKTtcbiAgfVxuXG4gIGFzeW5jIF91cGRhdGUgKCBzZXNzaW9uSWQsIGZhaWx1cmVzLCBjYWxsZWRPblJlbG9hZCA9IGZhbHNlLCBicm93c2VyTmFtZSApIHtcbiAgICBjb25zdCBzbGVlcCA9IG1zID0+IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCBtcykpO1xuICAgIFxuICAgIGF3YWl0IHNsZWVwKDUwMDApXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudXBkYXRlSm9iKHNlc3Npb25JZCwgZmFpbHVyZXMsIGNhbGxlZE9uUmVsb2FkLCBicm93c2VyTmFtZSk7XG4gIH1cblxuICBhc3luYyB1cGRhdGVKb2Ioc2Vzc2lvbklkLCBmYWlsdXJlcywgY2FsbGVkT25SZWxvYWQgPSBmYWxzZSwgYnJvd3Nlck5hbWUpIHtcbiAgICBjb25zdCBib2R5ID0gdGhpcy5nZXRCb2R5KGZhaWx1cmVzLCBjYWxsZWRPblJlbG9hZCwgYnJvd3Nlck5hbWUpO1xuICAgIHRyeXtcbiAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmFwaS51cGRhdGVTZXNzaW9uQnlJZChzZXNzaW9uSWQsIGJvZHksIChlcnIsIHJlc3VsdCkgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc29sdmUocmVzdWx0KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG4gIGNhdGNoKGV4KXtcbiAgICBjb25zb2xlLmxvZyhleCk7XG4gIH1cbiAgICB0aGlzLmZhaWx1cmVzID0gMDtcbiAgfVxuXG4gIGdldEJvZHkoZmFpbHVyZXMsIGNhbGxlZE9uUmVsb2FkID0gZmFsc2UsIGJyb3dzZXJOYW1lKSB7XG4gICAgbGV0IGJvZHkgPSB7fTtcbiAgICBpZiAoISghZ2xvYmFsLmJyb3dzZXIuaXNNdWx0aXJlbW90ZSAmJiB0aGlzLmNhcGFiaWxpdGllcy5uYW1lIHx8IGdsb2JhbC5icm93c2VyLmlzTXVsdGlyZW1vdGUgJiYgdGhpcy5jYXBhYmlsaXRpZXNbYnJvd3Nlck5hbWVdLmNhcGFiaWxpdGllcy5uYW1lKSkge1xuICAgICAgbGV0IHRlc3ROYW1lID0gdGhpcy5zdWl0ZVRpdGxlXG4gICAgICBcbiAgICAgIGJvZHkubmFtZSA9IHRlc3ROYW1lXG4gICAgICBcbiAgICAgIGlmICh0aGlzLmNhcGFiaWxpdGllc1snTFQ6T3B0aW9ucyddICYmIHRoaXMuY2FwYWJpbGl0aWVzWydMVDpPcHRpb25zJ10ubmFtZSl7XG4gICAgICAgIGJvZHkubmFtZSA9IHRoaXMuY2FwYWJpbGl0aWVzWydMVDpPcHRpb25zJ10ubmFtZVxuICAgICAgfVxuICAgICAgXG4gICAgICBpZiAoYnJvd3Nlck5hbWUpIHtcbiAgICAgICAgYm9keS5uYW1lID0gYCR7YnJvd3Nlck5hbWV9OiAke2JvZHkubmFtZX1gO1xuICAgICAgfVxuXG4gICAgICBpZiAoY2FsbGVkT25SZWxvYWQgfHwgdGhpcy50ZXN0Q250KSB7XG4gICAgICAgIGxldCB0ZXN0Q250ID0gKyt0aGlzLnRlc3RDbnQ7XG5cbiAgICAgICAgaWYgKGdsb2JhbC5icm93c2VyLmlzTXVsdGlyZW1vdGUpIHtcbiAgICAgICAgICB0ZXN0Q250ID0gTWF0aC5jZWlsKHRlc3RDbnQgLyBnbG9iYWwuYnJvd3Nlci5pbnN0YW5jZXMubGVuZ3RoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGJvZHkubmFtZSArPSBgICgke3Rlc3RDbnR9KWA7XG4gICAgICB9XG4gICAgfVxuXG4gICAgYm9keS5zdGF0dXNfaW5kID0gZmFpbHVyZXMgPiAwID8gJ2ZhaWxlZCcgOiAncGFzc2VkJztcbiAgICByZXR1cm4gYm9keTtcbiAgfVxuXG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTtBQUNBO0FBQWlDO0FBRWpDLE1BQU1BLEdBQUcsR0FBRyxJQUFBQyxlQUFNLEVBQUMsMEJBQTBCLENBQUM7QUFFL0IsTUFBTUMsaUJBQWlCLENBQUM7RUFDckNDLFdBQVcsR0FBRztJQUNaLElBQUksQ0FBQ0MsT0FBTyxHQUFHLENBQUM7SUFDaEIsSUFBSSxDQUFDQyxRQUFRLEdBQUcsQ0FBQztFQUNuQjtFQUVBQyxhQUFhLENBQUNDLE1BQU0sRUFBRUMsWUFBWSxFQUFFO0lBQ2xDLElBQUksQ0FBQ0QsTUFBTSxHQUFHQSxNQUFNO0lBQ3BCLElBQUksQ0FBQ0MsWUFBWSxHQUFHQSxZQUFZO0lBQ2hDLE1BQU1DLGlCQUFpQixHQUFHO01BQ3hCQyxRQUFRLEVBQUUsSUFBSSxDQUFDSCxNQUFNLENBQUNJLElBQUk7TUFDMUJDLFNBQVMsRUFBRSxJQUFJLENBQUNMLE1BQU0sQ0FBQ00sR0FBRztN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